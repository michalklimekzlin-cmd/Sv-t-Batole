<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Batolesvět • Viri</title>
  <style>
    html,body{margin:0;height:100%;background:#000;color:#9ff;font-family:system-ui,-apple-system,sans-serif;overflow:hidden}
    .btn{position:fixed;padding:6px 14px;border-radius:.6rem;border:1px solid #333;background:rgba(40,40,40,.85);color:#cbe;font-weight:600;backdrop-filter:blur(8px) saturate(120%);transition:.25s}
    .btn:hover{background:rgba(65,65,65,.9)}
    #btnTopLeft{top:20px;left:20px} #btnTopRight{top:20px;right:20px}
    #btnBottomLeft{bottom:20px;left:20px} #btnBottomRight{bottom:20px;right:20px}
    #worldLabel{position:fixed;left:0;right:0;bottom:72px;text-align:center;font-size:18px;opacity:.85}
    #wrap{position:fixed;inset:0;display:grid;place-items:center}
    canvas{width:min(92vmin,720px);height:min(92vmin,720px);display:block}
    /* DEBUG overlay */
    #dbg{position:fixed;left:12px;bottom:12px;padding:8px 10px;border:1px solid #355;background:rgba(0,20,30,.6);
         color:#bff;border-radius:.6rem;font:600 12px/1.35 system-ui, -apple-system, sans-serif;white-space:pre}
  </style>
</head>
<body>

  <!-- rohové ovladače -->
  <div id="btnTopLeft" class="btn">Batolesvět</div>
  <div id="btnTopRight" class="btn">Glyph</div>
  <div id="btnBottomLeft" class="btn">Pedrovci</div>
  <div id="btnBottomRight" class="btn">AI</div>

  <div id="worldLabel">Svět: Michal Klimek</div>

  <!-- centrální plátno pro Viriho -->
  <div id="wrap"><canvas id="canvasVafi" width="1024" height="1024"></canvas></div>

  <!-- DEBUG overlay -->
  <div id="dbg">boot…</div>

  <!-- cache-busting -->
  <script>window.V=(new URL(location)).searchParams.get('v')||Date.now()+'';</script>

  <!-- (ponechávám i tvé existující moduly – mohou být prázdné, nevadí) -->
  <script type="module" src="./config.js?v="+V></script>
  <script type="module" src="./state.core.js?v="+V></script>
  <script type="module" src="./memory.core.js?v="+V></script>
  <script type="module" src="./rules.guardrails.js?v="+V></script>
  <script type="module" src="./world.builder.js?v="+V></script>
  <script type="module" src="./feeds.ai.js?v="+V></script>
  <script type="module" src="./feeds.glyph.js?v="+V></script>
  <script type="module" src="./exporter.vafi.js?v="+V></script>
  <script type="module" src="./dream.hud.js?v="+V></script>

  <!-- ===== VIRI: forma + zkušenosti + události ===== -->
  <script type="module">
    import { startViriForm }   from './viri.form.js?v='+V;
    import { ViriXP }          from './viri.experience.js?v='+V;
    import { EVENTS, initViriLearning } from './events.core.js?v='+V;

    const dbg   = document.getElementById('dbg');
    const cv    = document.getElementById('canvasVafi');
    const viri  = startViriForm(cv);                  // kreslíme
    const xp    = new ViriXP();                       // zkušenosti

    // propojení „učení“ s eventy
    initViriLearning(xp);

    // UI – rohy posílají signály
    const L=id=>document.getElementById(id);
    L('btnTopLeft')    .addEventListener('click',()=>EVENTS.voice ({team:'batolesvet', text:'drž se',   weight:+1.0}));
    L('btnTopRight')   .addEventListener('click',()=>EVENTS.voice ({team:'glyph',      text:'→',        weight:+0.7}));
    L('btnBottomLeft') .addEventListener('click',()=>EVENTS.mood  ({anxiety:-0.05, calm:+0.06, team:'pedrovci'}));
    L('btnBottomRight').addEventListener('click',()=>EVENTS.voice ({team:'ai',         text:'analýza',  weight:+0.8}));

    // hlavní smyčka
    function loop(){
      xp.tick();                     // zpracuj zkušenosti (decay, label…)
      const s = xp.getState();       // {mix:{…}, label, mood}
      viri.setMix(s.mix);            // promítni do podoby

      dbg.textContent =
        `mix  batole:${s.mix.batolesvet.toFixed(2)}  glyph:${s.mix.glyph.toFixed(2)}  ai:${s.mix.ai.toFixed(2)}  pedro:${s.mix.pedrovci.toFixed(2)}
label ${s.label}    mood calm:${s.mood.calm.toFixed(2)} anx:${s.mood.anxiety.toFixed(2)}`;

      requestAnimationFrame(loop);
    }
    loop();

    // TEST simulace (ať se to hýbe i bez klikání)
    let t=0; setInterval(()=>{
      xp.add({team:'batolesvet', value:Math.abs(Math.sin(t*0.35))*1.7});
      xp.add({team:'glyph',      value:Math.abs(Math.sin(t*0.55))*1.3});
      xp.add({team:'ai',         value:Math.abs(Math.sin(t*0.75))*1.6});
      xp.add({team:'pedrovci',   value:Math.abs(Math.cos(t*0.42))*1.4});
      t+=0.05;
    },200);
  </script>
</body>
</html>