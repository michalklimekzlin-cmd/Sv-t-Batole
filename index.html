<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>BatoleSvět — v0.31 (One-File Build)</title>
  <meta name="theme-color" content="#0b0b0c" />

  <!-- NUKE CACHE / SW: jednorázově odregistruje SW a smaže cache -->
  <script>
  (function(){
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(regs=>{
        regs.forEach(r=>r.unregister());
        if (window.caches) caches.keys().then(keys=>keys.forEach(k=>caches.delete(k)));
      }).catch(()=>{});
    }
  })();
  </script>

  <style>
  :root { --bg:#0b0b0c; --fg:#e9e9ea; --muted:#a7a8ad; --card:#15161a; --border:#2a2b31; --accent:#7aa2f7; --accent2:#89dceb; --danger:#ef4444; }
  @media (prefers-color-scheme: light){
    :root{--bg:#fafafa;--fg:#111;--muted:#5b5e66;--card:#fff;--border:#e8e8ef;--accent:#3b82f6;--accent2:#06b6d4;--danger:#ef4444;}
  }
  *{box-sizing:border-box} html,body{margin:0;padding:0}
  body{font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;background:var(--bg);color:var(--fg)}
  .topbar{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg);z-index:10}
  .brand{font-weight:800}
  .stats{display:flex;gap:12px;color:var(--muted);font-size:13px;align-items:center;flex-wrap:wrap}
  .stats .mission{color:var(--fg)}
  .voicebar .chip{padding:6px 10px}
  .wrap{max-width:980px;margin:0 auto;padding:10px}
  #game{width:100%;height:auto;border:1px solid var(--border);border-radius:12px;background:#0d0f14;display:block}
  .controls{margin-top:10px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .btn{border:1px solid var(--border);background:var(--card);color:var(--fg);padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700;min-height:40px}
  .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#0b0b0c}
  .btn.danger{color:var(--danger);border-color:var(--danger)}
  .chip{border:1px solid var(--border);border-radius:999px;background:rgba(127,127,127,.08);padding:8px 12px;cursor:pointer}
  .text{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--fg)}
  .muted{color:var(--muted)} .small{font-size:12px}
  .log{margin-top:10px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
  .log h3{margin-top:0}
  .log-item{border-bottom:1px solid var(--border);padding:6px 0;font-size:14px}
  .footer{display:flex;justify-content:space-between;align-items:center;padding:12px;border-top:1px solid var(--border);color:var(--muted)}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:50}
  .overlay.show{display:flex}
  .overlay-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;max-width:520px;margin:0 14px;text-align:center}
  .overlay-card.wide-card{max-width:900px;text-align:left}
  .overlay-card h1,.overlay-card h2{margin:0 0 8px}
  .overlay-card .wide{width:100%}
  .tip{position:fixed;background:var(--card);border:1px solid var(--border);padding:10px 12px;border-radius:12px;color:var(--fg);z-index:40;display:none}
  #tip1{left:16px;bottom:140px}
  #tip2{left:16px;bottom:140px}
  @media (orientation:portrait){ #game{height:60vh} }

  /* Chat – menší a sbalitelný */
  .chat{ position:fixed; right:12px; bottom:68px; z-index:60; width:320px; max-height:42vh; display:none; }
  .chat.show{ display:block; }
  .chat-log{ max-height:32vh; overflow:auto; background:var(--card); border:1px solid var(--border); border-radius:12px; padding:10px 10px 4px; box-shadow:0 10px 30px rgba(0,0,0,.25) }
  .msg{display:flex;gap:8px;margin:6px 0}
  .msg .bubble{padding:10px 12px;border-radius:12px;max-width:80%}
  .msg.ai .bubble{background:rgba(137,220,235,.12);border:1px solid var(--border)}
  .msg.me .bubble{background:rgba(122,162,247,.15);border:1px solid var(--border);margin-left:auto}
  .chat-choices{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .choice{border:1px solid var(--border);background:var(--card);color:var(--fg);padding:8px 10px;border-radius:999px;cursor:pointer}
  .choice:hover{border-color:var(--accent)}

  /* FAB tlačítko pro chat */
  .fab{ position:fixed; right:12px; bottom:12px; z-index:61; width:48px; height:48px; border-radius:50%; border:1px solid var(--border); background:var(--card); color:var(--fg); font-size:22px; line-height:48px; text-align:center; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.25); }

  /* Toast – krátká nenásilná hláška */
  .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:16px; z-index:62; min-width:160px; max-width:70vw; background:var(--card); color:var(--fg); border:1px solid var(--border); border-radius:999px; padding:8px 14px; font-size:14px; display:none; }
  .toast.show{ display:block; }

  /* Workshop */
  .ws-log{ background:var(--bg); border:1px dashed var(--border); border-radius:12px; padding:10px; max-height:40vh; overflow:auto; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:13px; line-height:1.45; white-space:pre-wrap; }
  .ws-log .ok{color:#a7f3d0} .ws-log .warn{color:#fde68a} .ws-log .err{color:#fecaca}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">🍼 BatoleSvět — v0.31</div>
    <nav class="stats">
      <span>Cyklus: <strong id="statCycle">0</strong></span>
      <span>Důvěra: <strong id="statTrust">1</strong></span>
      <span>Jasnost: <strong id="statClarity">1</strong></span>
      <span>Energie: <strong id="statEnergy">3</strong></span>
      <span class="mission">Mise: <strong id="missionProg">0/5</strong></span>
      <span class="voicebar">
        <button id="voiceToggle" class="chip">🎧 Hlas: off</button>
        <button id="micToggle" class="chip">🎤 Mikrofon: off</button>
        <button id="settingsBtn" class="chip">⚙️ Parťák</button>
        <button id="workshopBtn" class="chip">🧪 AI dílna</button>
      </span>
    </nav>
  </header>

  <main class="wrap">
    <canvas id="game" width="800" height="480" aria-label="BatoleSvět herní plátno"></canvas>

    <section class="controls">
      <div class="row">
        <button class="btn" data-imp="whisper">Šepot</button>
        <button class="btn" data-imp="ask">Otázka</button>
        <button class="btn" data-imp="command">Povel</button>
        <button class="btn" data-imp="reflect">Reflexe</button>
        <button id="aiBtn" class="btn primary">AI odpověď</button>
      </div>
      <div class="row wrapline">
        <button class="chip" data-sym="key">🔑 Klíč</button>
        <button class="chip" data-sym="lock">🔒 Zámek</button>
        <button class="chip" data-sym="eagle">🦅 Orel</button>
        <button id="weaveBtn" class="btn">Utkej vzor</button>
        <button id="resetBtn" class="btn danger">Reset</button>
        <button id="shopBtn" class="btn">🛍️ Obchod (brzy)</button>
      </div>
    </section>

    <section class="log">
      <h3>Deník</h3>
      <div id="log"></div>
    </section>
  </main>

  <footer class="footer">
    <span>© Kovošrot &amp; Batole</span>
  </footer>

  <!-- Intro -->
  <div id="intro" class="overlay show">
    <div class="overlay-card">
      <h1>Svět se hýbe jen impulsem.</h1>
      <p class="muted">Začni, až budeš připraven.</p>
      <button id="startBtn" class="btn primary wide">Začít</button>
    </div>
  </div>

  <!-- Pojmenuj parťáka + persona -->
  <div id="nameAsk" class="overlay">
    <div class="overlay-card">
      <h2>Pojmenuj svého parťáka</h2>
      <p class="muted">Napiš vlastní jméno, nebo ťukni na návrh a vyber styl mluvy.</p>
      <input id="nameInput" class="text" type="text" maxlength="20" placeholder="Např. Orbit" />
      <div id="personaRow1" class="row" style="margin-top:8px"></div>
      <div class="row" style="margin-top:8px">
        <button id="nameConfirm" class="btn wide">Pokračovat</button>
      </div>
    </div>
  </div>

  <!-- Nastavení parťáka -->
  <div id="settings" class="overlay">
    <div class="overlay-card">
      <h2>Parťák — nastavení</h2>
      <div id="personaRow2" class="row" style="margin-bottom:8px"></div>
      <div class="row" style="margin-bottom:8px">
        <button id="toneToggle" class="chip">🗣️ Tón: Auto</button>
      </div>
      <div class="row">
        <button id="settingsClose" class="btn wide">Zavřít</button>
      </div>
    </div>
  </div>

  <!-- Tutorial -->
  <div id="tip1" class="tip">Zkus <strong>Šepot</strong> (stojí 1 energii).</div>
  <div id="tip2" class="tip">Teď klikni na <strong>AI odpověď</strong>.</div>

  <!-- Mission complete -->
  <div id="missionDone" class="overlay">
    <div class="overlay-card">
      <h1>Most je otevřen</h1>
      <p class="muted">Důvěra +1 • Energie +1</p>
      <button id="continueBtn" class="btn wide">Volné hraní</button>
    </div>
  </div>

  <!-- Chat -->
  <div id="chat" class="chat">
    <div id="chatLog" class="chat-log" aria-live="polite"></div>
    <div id="chatChoices" class="chat-choices"></div>
  </div>
  <button id="chatToggle" class="fab" aria-label="Otevřít chat">💬</button>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- AI Workshop -->
  <div id="workshop" class="overlay">
    <div class="overlay-card wide-card">
      <h2>🧪 AI dílna</h2>
      <p class="muted small">Agenti navrhnou patch. Ty rozhodneš: Aplikovat / Zpět.</p>
      <div id="wsLog" class="ws-log"></div>
      <div class="row" style="margin-top:10px">
        <button id="wsPropose" class="btn">Navrhnout patch</button>
        <button id="wsApply" class="btn primary">Aplikovat</button>
        <button id="wsUndo" class="btn">Zpět</button>
        <button id="wsClose" class="btn">Zavřít</button>
      </div>
    </div>
  </div>

  <script>
  // ====== app.v031.js (inline) ======
  const $ = (s)=>document.querySelector(s);
  const now = ()=>Date.now();
  const SKEY = 'batolesvet:v031';
  let state = JSON.parse(localStorage.getItem(SKEY) || 'null') || {
    cycle:0, trust:1, clarity:1, energy:3,
    pendingImpulse:null, syms:[],
    nodes:Array.from({length:9},(_,i)=>({idx:i,level:0,active:false})),
    log:[],
    player:{x:400,y:240,r:16,spd:2},
    ai:{phase:0,dist:40,particles:48},
    ui:{phase:'intro', mission:{target:5, progress:0, done:false}, tutorial:{step:0}},
    companionName:null,
    persona:'orbit', tone:'auto', path:null,
    chat:{on:true, log:[], awaiting:false, lastPrompt:null},
    voice:{enabled:false, voiceURI:null, pitch:1, rate:1},
    mic:{enabled:false, supported:false},
    workshop:{queue:[], last:null, history:[]}
  };
  function save(){ localStorage.setItem(SKEY, JSON.stringify(state)); }
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function logMsg(t){ state.log.unshift({t:now(),text:t}); renderLog(); save(); }

  // --- BroNet (síť agentů) ---
  const BroNet = { subs:{}, publish(topic,p){(this.subs[topic]||[]).forEach(fn=>{try{fn(p)}catch(e){}})}, subscribe(topic,fn){this.subs[topic]=(this.subs[topic]||[]).concat(fn);} };
  let hintQueue=[], preActQueue=[];
  function enqueueHint(t){ hintQueue.push(t); }
  function enqueuePreAct(fn){ preActQueue.push(fn); }
  BroNet.subscribe('pathChanged',(path)=>{
    hintQueue=[]; preActQueue=[];
    if(path==='key'){ enqueueHint('Za chvíli zkus přesnou Otázku – přidá jasnost.'); enqueuePreAct(()=>{ const i=Math.floor(Math.random()*state.nodes.length); neighbors(i).forEach(n=> state.nodes[n].level+=1); }); }
    if(path==='lock'){ enqueueHint('Drž rytmus. Když to bude křehké, zpevním aktivní.'); enqueuePreAct(()=>{ state.nodes.filter(n=>n.active).forEach(n=> n.level+=1); }); }
    if(path==='eagle'){ enqueueHint('Zkus tkaní s Orlem – roznesu jiskry do okolí.'); enqueuePreAct(()=>{ const i=Math.floor(Math.random()*state.nodes.length); neighbors(i).forEach(n=> state.nodes[n].level+=1); }); }
  });

  // --- Persony (včetně Ferum) ---
  let PERSONAS = {
    orbit:{ label:'🌀 Orbit', intro:'Logika je můj domov, ale humor mi není cizí.', style:{humor:0.4, empathy:0.5, tempo:1.0} },
    miza: { label:'🌱 Míza',  intro:'Dýchej. Já pohlídám rytmus a náladu světa.',    style:{humor:0.3, empathy:0.9, tempo:0.95} },
    iskra:{ label:'⚡ Iskra', intro:'Když to jiskří, znamená to, že žiju! Jdeme na to.', style:{humor:0.8, empathy:0.5, tempo:1.05} },
    ferum:{ label:'🛡️ Ferum', intro:'Držím linii. Tvoř klidně, já pohlídám rám.',      style:{humor:0.25, empathy:0.6, tempo:0.92} }
  };
  function personaName(){ if(state.companionName) return state.companionName; return state.persona==='miza'?'Míza':state.persona==='iskra'?'Iskra':state.persona==='ferum'?'Ferum':'Orbit'; }
  function personaSay(text){ chatPush('ai', `${personaName()}: ${text}`); if(state.voice.enabled) speak(text); }

  function personaTips(kind){
    const simple=state.tone==='simple', P=state.persona;
    if(kind==='mission'){
      if(P==='miza') return simple?'Zkus klidně aktivovat pět uzlů.':'Aktivuj pět uzlů. Jdeme hezky s dechem.';
      if(P==='iskra') return simple?'Pět uzlů! Rozjeď to!':'Pět uzlů a jedeme! Když to jiskří, jsi na správné stopě.';
      if(P==='ferum') return simple?'Pět uzlů a žádné spěchy.':'Pět uzlů. Je to o trpělivosti – já držím štít.';
      return simple?'Cíl je pět uzlů.':'Cíl je pět aktivních uzlů. Postupuj systematicky.';
    }
    if(kind==='energy'){
      if(P==='miza') return simple?'Když dojde energie, zvol jemnější impulsy.':'Když energie klesá, zpomal a použij jemnější impulsy.';
      if(P==='iskra') return simple?'Došla? Zkus Klíč+Zámek.':'Energie na nule? Vzor Klíč+Zámek občas vrátí +1.';
      if(P==='ferum') return simple?'Dej si pauzu mezi kroky.':'Drž rytmus – krátké pauzy mezi impulsy šetří zásobu.';
      return simple?'Drž rytmus a používej šepot.':'Drž rytmus. Šepoty málo stojí, refund dává Klíč+Zámek.';
    }
    if(kind==='nudge'){
      if(P==='miza') return simple?'Hezky. Ještě kousek.':'Hezky. Přidám kousek světla, ať vidíš dál.';
      if(P==='iskra') return simple?'Bum! Ještě jiskru.':'Bum! Přihodil jsem jiskru do sousedů.';
      if(P==='ferum') return simple?'Držím to pevné.':'Zpevnil jsem konstrukci. Můžeš klidně pokračovat.';
      return simple?'Stabilizuji.':'Stabilizuji aktivní uzly pro plynulejší postup.';
    }
    return '';
  }

  // UI
  document.querySelectorAll('.btn[data-imp]').forEach(b=>b.addEventListener('click',()=> sendImpulse(b.dataset.imp)));
  $('#aiBtn').addEventListener('click',()=> aiRespond());
  document.querySelectorAll('.chip[data-sym]').forEach(c=>c.addEventListener('click',()=> toggleSym(c)));
  $('#weaveBtn').addEventListener('click',()=> weave());
  $('#resetBtn').addEventListener('click',()=>{ localStorage.removeItem(SKEY); location.reload(); });

  $('#startBtn').addEventListener('click', ()=>{ $('#intro').classList.remove('show'); $('#nameAsk').classList.add('show'); renderPersonaButtons('#personaRow1'); });
  $('#nameConfirm').addEventListener('click', ()=>{ const val=($('#nameInput').value||'').trim(); if(val) state.companionName=val; $('#nameAsk').classList.remove('show'); startTutorial(); startCompanionIntro(); save(); });

  $('#settingsBtn').addEventListener('click', ()=>{ renderPersonaButtons('#personaRow2'); $('#settings').classList.add('show'); });
  $('#settingsClose').addEventListener('click', ()=> $('#settings').classList.remove('show'));
  $('#toneToggle').addEventListener('click', ()=>{ state.tone=state.tone==='auto'?'simple':'auto'; $('#toneToggle').textContent=`🗣️ Tón: ${state.tone==='auto'?'Auto':'Simple'}`; save(); });

  // Voice/Mic
  $('#voiceToggle').addEventListener('click', ()=>{ state.voice.enabled=!state.voice.enabled; $('#voiceToggle').textContent=`🎧 Hlas: ${state.voice.enabled?'on':'off'}`; if(state.voice.enabled){ speak(`${personaName()} je připraven mluvit.`); } save(); });
  $('#micToggle').addEventListener('click', ()=>{ if(!state.mic.supported){ alert('Mikrofonová interpretace není podporovaná.'); return; } state.mic.enabled=!state.mic.enabled; $('#micToggle').textContent=`🎤 Mikrofon: ${state.mic.enabled?'on':'off'}`; if(state.mic.enabled) startListen(); else stopListen(); save(); });

  // Workshop
  $('#workshopBtn').addEventListener('click', ()=>{ $('#workshop').classList.add('show'); renderWS(); });
  $('#wsClose').addEventListener('click', ()=> $('#workshop').classList.remove('show'));
  $('#wsPropose').addEventListener('click', ()=> { proposePatch(); renderWS(); });
  $('#wsApply').addEventListener('click', ()=> { applyLastPatch(); renderWS(); });
  $('#wsUndo').addEventListener('click', ()=> { undoPatch(); renderWS(); });

  // Chat + FAB + toast
  const elChatLog=()=>$('#chatLog'); const elChoices=()=>$('#chatChoices');
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function chatPush(who,text){ state.chat.log.push({who,text,t:now()}); renderChat(); if(who==='ai' && !$('#chat').classList.contains('show')) showToast(text); }
  function renderChat(){ const list=state.chat.log.slice(-50).map(m=>`<div class="msg ${m.who==='ai'?'ai':'me'}"><div class="bubble">${escapeHtml(m.text)}</div></div>`).join(''); elChatLog().innerHTML=list; elChatLog().scrollTop=elChatLog().scrollHeight; }
  function setChoices(arr){ elChoices().innerHTML=arr.map(c=>`<button class="choice" data-id="${c.id}">${escapeHtml(c.label)}</button>`).join(''); elChoices().querySelectorAll('.choice').forEach(b=> b.onclick=()=>handleChoice(b.dataset.id)); state.chat.awaiting=!!arr.length; }
  function clearChoices(){ elChoices().innerHTML=''; state.chat.awaiting=false; }
  function meSay(text){ chatPush('me',text); }
  $('#chatToggle').addEventListener('click', ()=>{ $('#chat').classList.toggle('show'); });
  let toastTimer=null; function showToast(msg,ms=1800){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(toastTimer); toastTimer=setTimeout(()=> t.classList.remove('show'), ms); }

  // Intro/Dialog
  function startCompanionIntro(){
    const p=PERSONAS[state.persona];
    personaSay(`Ahoj, jsem ${personaName()}. ${p.intro}`);
    personaSay('Chceš rychlou radu, nebo si zvolit cestu světem?');
    setChoices([{id:'help_quick',label:'Dej mi rychlou radu'},{id:'help_paths',label:'Chci si zvolit cestu'},{id:'help_soft',label:'Rozhlédnu se sám'}]);
    state.chat.lastPrompt='intro';
  }
  function handleChoice(id){
    clearChoices();
    const labels={help_quick:'Dej mi rychlou radu',help_paths:'Chci si zvolit cestu',help_soft:'Rozhlédnu se sám',path_key:'Cesta Klíče',path_lock:'Cesta Zámku',path_eagle:'Cesta Orla',ask_mission:'Jak splním misi?',ask_energy:'Jak doplním energii?'};
    meSay(labels[id]||'…');
    switch(id){
      case 'help_quick': personaSay('Začni Šepotem a pak klikni na AI odpověď.'); personaSay(personaTips('mission')); setChoices([{id:'ask_mission',label:'Jak splním misi?'},{id:'ask_energy',label:'Jak doplním energii?'},{id:'help_paths',label:'Zvolit cestu'}]); break;
      case 'help_paths': personaSay('Tři cesty: 🔑 Klíč (jasnost), 🔒 Zámek (stabilita), 🦅 Orel (propojení). Co cítíš?'); setChoices([{id:'path_key',label:'🔑 Cesta Klíče'},{id:'path_lock',label:'🔒 Cesta Zámku'},{id:'path_eagle',label:'🦅 Cesta Orla'}]); break;
      case 'help_soft': personaSay('Rozhlédni se. Až budeš chtít, řekni „Zvolit cestu“.'); setChoices([{id:'help_paths',label:'Zvolit cestu'}]); break;
      case 'path_key': state.path='key'; personaSay('Zvoleno: Cesta Klíče. Občas ti rozsvítím jasnost.'); BroNet.publish('pathChanged','key'); break;
      case 'path_lock': state.path='lock'; personaSay('Zvoleno: Cesta Zámku. Zpevním aktivní uzly, když to bude křehké.'); BroNet.publish('pathChanged','lock'); break;
      case 'path_eagle': state.path='eagle'; personaSay('Zvoleno: Cesta Orla. Roznesu jiskry do okolí, až to bude dávat smysl.'); BroNet.publish('pathChanged','eagle'); break;
      case 'ask_mission': personaSay(personaTips('mission')); break;
      case 'ask_energy': personaSay(personaTips('energy')); break;
    }
    save();
  }

  // Tutorial/Mission
  function startTutorial(){ state.ui.phase='tutorial'; state.ui.tutorial.step=1; showTip('#tip1'); save(); }
  function showTip(id){ ['#tip1','#tip2'].forEach(sel=>$(sel).style.display='none'); $(id).style.display='block'; }
  function hideTips(){ ['#tip1','#tip2'].forEach(sel=>$(sel).style.display='none'); }
  function updateMission(){
    if(state.ui.phase!=='mission') return;
    const count=state.nodes.filter(n=>n.active).length;
    state.ui.mission.progress=Math.min(count,state.ui.mission.target);
    $('#missionProg').textContent=`${state.ui.mission.progress}/${state.ui.mission.target}`;
    if(!state.ui.mission.done && state.ui.mission.progress>=state.ui.mission.target){
      state.ui.mission.done=true; state.trust=clamp(state.trust+1,0,10); state.energy=clamp(state.energy+1,0,5);
      $('#missionDone').classList.add('show'); personaSay('Most je otevřen. Volné hraní je tvoje. Chceš další výzvu?');
    }
  }
  $('#continueBtn').addEventListener('click', ()=>{ $('#missionDone').classList.remove('show'); state.ui.phase='free'; save(); });

  // Herní akce
  function toggleSym(el){ const val=el.dataset.sym; if(state.syms.includes(val)) state.syms=state.syms.filter(x=>x!==val); else state.syms.push(val); el.classList.toggle('selected'); }
  function sendImpulse(type){
    if(state.pendingImpulse) return alert('AI stále čeká na odpověď.');
    if(state.energy<=0) return alert('Nedostatek energie.');
    state.energy-=1; state.pendingImpulse={type,t:now(),intensity:2};
    if(state.ui.phase==='tutorial' && state.ui.tutorial.step===1){ hideTips(); showTip('#tip2'); state.ui.tutorial.step=2; }
    logMsg(`Impuls: ${type}`); updateStats();
  }
  function aiRespond(){
    if(!state.pendingImpulse) return;
    const {type}=state.pendingImpulse;
    const idx=(state.cycle + (type==='command'?2:type==='ask'?1:0)) % state.nodes.length;
    const node=state.nodes[idx];
    let trust=0,clarity=0;
    switch(type){
      case 'whisper': node.level+=1; trust+=1; clarity+=1; break;
      case 'ask': node.level+=2; clarity+=2; break;
      case 'command': node.level+=3; trust-=1; clarity+=1; break;
      case 'reflect': node.level+=1; neighbors(idx).forEach(i=>state.nodes[i].level+=1); trust+=1; clarity+=2; break;
    }
    state.nodes.forEach(n=>n.active=n.level>=2);
    state.trust=clamp(state.trust+trust,0,10);
    state.clarity=clamp(state.clarity+clarity,0,10);
    state.cycle+=1; state.pendingImpulse=null;
    logMsg('AI odpověděla.');

    // BroNet jemný „tah dopředu“
    if(preActQueue.length){ const act=preActQueue.shift(); try{act();}catch(e){} state.nodes.forEach(n=>n.active=n.level>=2); }
    if(hintQueue.length){ const tip=hintQueue.shift(); personaSay(tip); }

    if(state.ui.phase==='tutorial' && state.ui.tutorial.step===2){ hideTips(); state.ui.phase='mission'; personaSay(personaTips('mission')); }
    companionPassiveNudge(); updateMission(); updateStats();
  }
  function weave(){
    if(state.syms.length===0){ alert('Vyber aspoň jeden symbol.'); return; }
    let trust=0, clarity=0, refund=0;
    const target=Math.floor(Math.random()*state.nodes.length);
    const hasKey=state.syms.includes('key'), hasLock=state.syms.includes('lock'), hasEagle=state.syms.includes('eagle');
    const node=state.nodes[target];
    if(hasKey){ node.level+=1; trust+=1; }
    if(hasLock){ state.nodes.filter(n=>n.active).forEach(n=>n.level+=1); refund+=1; }
    if(hasEagle){ neighbors(target).forEach(i=>state.nodes[i].level+=1); clarity+=2; }
    if(hasKey&&hasEagle){ state.nodes.forEach(n=>{ if(n.active) n.level+=1;}); clarity+=1; }
    if(hasKey&&hasLock){ trust+=1; refund+=1; }
    if(hasLock&&hasEagle){ clarity+=1; }
    state.nodes.forEach(n=>n.active=n.level>=2);
    if(state.energy>0) state.energy-=1; if(refund) state.energy=clamp(state.energy+refund,0,5);
    state.trust=clamp(state.trust+trust,0,10); state.clarity=clamp(state.clarity+clarity,0,10);
    state.cycle+=1; logMsg(`Upleten vzor: ${state.syms.join('+')}`); companionPassiveNudge(); updateMission(); updateStats();
  }

  // Pasivní pomoc
  function companionPassiveNudge(){
    if(!state.path) return; let said=null;
    switch(state.path){
      case 'key': if(Math.random()<0.35){ state.clarity=clamp(state.clarity+1,0,10); said=personaTips('nudge'); } break;
      case 'lock': if(Math.random()<0.30){ state.nodes.filter(n=>n.active).forEach(n=>n.level+=1); said=personaTips('nudge'); } break;
      case 'eagle': if(Math.random()<0.28){ const pick=Math.floor(Math.random()*state.nodes.length); neighbors(pick).forEach(i=>state.nodes[i].level+=1); said=personaTips('nudge'); } break;
    }
    state.nodes.forEach(n=>n.active=n.level>=2); if(said) personaSay(said); save(); updateStats();
  }

  // Canvas
  const canvas=document.getElementById('game'); const ctx=canvas.getContext('2d'); let keys=new Set();
  window.addEventListener('keydown', e=>keys.add(e.key)); window.addEventListener('keyup', e=>keys.delete(e.key));
  const touch={active:false,sx:0,sy:0,dx:0,dy:0};
  canvas.addEventListener('touchstart',e=>{ const t=e.touches[0]; touch.active=true; touch.sx=t.clientX; touch.sy=t.clientY; touch.dx=0; touch.dy=0; },{passive:true});
  canvas.addEventListener('touchmove',e=>{ if(!touch.active) return; const t=e.touches[0]; touch.dx=(t.clientX-touch.sx); touch.dy=(t.clientY-touch.sy); },{passive:true});
  canvas.addEventListener('touchend',()=>{ touch.active=false; touch.dx=0; touch.dy=0; });
  function neighbors(i){ const r=Math.floor(i/3), c=i%3; const coords=[[r-1,c],[r+1,c],[r,c-1],[r,c+1]]; return coords.filter(([R,C])=>R>=0&&R<3&&C>=0&&C<3).map(([R,C])=>R*3+C); }
  function updateStats(){ $('#statCycle').textContent=state.cycle; $('#statTrust').textContent=state.trust; $('#statClarity').textContent=state.clarity; $('#statEnergy').textContent=state.energy; $('#missionProg').textContent=`${state.ui.mission.progress}/${state.ui.mission.target}`; save(); }
  function draw(){
    const ratio=window.devicePixelRatio||1; const w=canvas.clientWidth*ratio, h=canvas.clientHeight*ratio;
    if(canvas.width!==w||canvas.height!==h){ canvas.width=w; canvas.height=h; }
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const cell=Math.min(canvas.width,canvas.height)/6; ctx.strokeStyle='rgba(255,255,255,0.06)'; ctx.lineWidth=1;
    for(let x=cell;x<canvas.width;x+=cell){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
    for(let y=cell;y<canvas.height;y+=cell){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }
    const gridW=canvas.width*0.6, gridH=canvas.height*0.6; const gx=(canvas.width-gridW)/2, gy=(canvas.height-gridH)/2;
    for(let i=0;i<9;i++){ const r=Math.floor(i/3), c=i%3; const nx=gx+(c+0.5)*(gridW/3); const ny=gy+(r+0.5)*(gridH/3); const n=state.nodes[i];
      ctx.beginPath(); ctx.arc(nx,ny, 18+n.level*2, 0, Math.PI*2);
      ctx.strokeStyle = n.active?'rgba(122,162,247,0.9)':'rgba(122,162,247,0.35)'; ctx.lineWidth = n.active?3:1; ctx.stroke();
      ctx.fillStyle='rgba(137,220,235,0.08)'; ctx.fill();
    }
    let vx=0,vy=0; if(keys.has('w')||keys.has('ArrowUp')) vy-=1; if(keys.has('s')||keys.has('ArrowDown')) vy+=1; if(keys.has('a')||keys.has('ArrowLeft')) vx-=1; if(keys.has('d')||keys.has('ArrowRight')) vx+=1;
    if(touch.active){ vx+=touch.dx/80; vy+=touch.dy/80; } const len=Math.hypot(vx,vy)||1;
    state.player.x=Math.max(20,Math.min(canvas.width-20,state.player.x+vx/len*state.player.spd));
    state.player.y=Math.max(20,Math.min(canvas.height-20,state.player.y+vy/len*state.player.spd));
    ctx.beginPath(); ctx.fillStyle='#ffffff'; ctx.arc(state.player.x,state.player.y,state.player.r,0,Math.PI*2); ctx.fill();
    state.ai.phase += 0.02 + state.clarity*0.0005;
    for(let i=0;i<state.ai.particles;i++){ const ang=(i/state.ai.particles)*Math.PI*2+state.ai.phase; const dist=state.ai.dist+Math.sin(ang*3)*2+state.trust*1.2; const x=state.player.x+Math.cos(ang)*dist; const y=state.player.y+Math.sin(ang)*dist; ctx.fillStyle='rgba(137,220,235,0.85)'; ctx.fillRect(x,y,2,2); }
    requestAnimationFrame(draw);
  }
  function renderLog(){ const el=$('#log'); el.innerHTML=state.log.slice(0,12).map(e=>`<div class="log-item">${new Date(e.t).toLocaleTimeString()} — ${e.text.replace(/</g,'&lt;')}</div>`).join(''); }

  // TTS/MIC
  let voices=[]; function loadVoices(){ voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : []; const cz=voices.find(v=>/cs-CZ/i.test(v.lang)); state.voice.voiceURI=(cz&&cz.voiceURI)||(voices[0]&&voices[0].voiceURI)||null; }
  if('speechSynthesis' in window){ loadVoices(); window.speechSynthesis.onvoiceschanged=loadVoices; } else { $('#voiceToggle').style.display='none'; }
  function speak(text){ if(!state.voice.enabled||!('speechSynthesis'in window))return; const u=new SpeechSynthesisUtterance(text); const v=voices.find(x=>x.voiceURI===state.voice.voiceURI); if(v) u.voice=v; u.lang=(v&&v.lang)||'cs-CZ'; u.pitch=1.05; u.rate=0.92; window.speechSynthesis.speak(u); }
  const SR = window.SpeechRecognition||window.webkitSpeechRecognition||null; let reco=null;
  if(SR){ state.mic.supported=true; reco=new SR(); reco.lang='cs-CZ'; reco.continuous=true; reco.interimResults=false;
    reco.onresult=(e)=>{ for(let i=e.resultIndex;i<e.results.length;i++){ if(e.results[i].isFinal){ const text=e.results[i][0].transcript.trim(); meSay(text); interpretVoice(text.toLowerCase()); } } };
    reco.onend=()=>{ if(state.mic.enabled) startListen(); };
  }else{ $('#micToggle').style.display='none'; }
  function startListen(){ try{ reco&&reco.start(); }catch(e){} }
  function stopListen(){ try{ reco&&reco.stop(); }catch(e){} }
  function interpretVoice(t){
    if(/^\s*šepot|šeptem/.test(t)) return sendImpulse('whisper');
    if(/otázka/.test(t)) return sendImpulse('ask');
    if(/povel/.test(t)) return sendImpulse('command');
    if(/reflexe|reflex/.test(t)) return sendImpulse('reflect');
    if(/ai odpov(?:ěď|ed)/.test(t)) return aiRespond();
    if(/jak(é|e) (jsou )?cesty/.test(t)){ handleChoice('help_paths'); return; }
    if(/cesta kl(.|i)če|klíč/.test(t)){ state.path='key'; personaSay('Zvoleno: Cesta Klíče.'); BroNet.publish('pathChanged','key'); return; }
    if(/cesta zámku|zámek/.test(t)){ state.path='lock'; personaSay('Zvoleno: Cesta Zámku.'); BroNet.publish('pathChanged','lock'); return; }
    if(/cesta orla|orel/.test(t)){ state.path='eagle'; personaSay('Zvoleno: Cesta Orla.'); BroNet.publish('pathChanged','eagle'); return; }
    personaSay('Rozumím ti, ale tohle zatím neumím. Zkus: „Šepot“, „AI odpověď“ nebo „Jaké jsou cesty?“');
  }

  // Persona buttons
  function renderPersonaButtons(sel){
    const el=$(sel); if(!el) return;
    const PERSONAS = { orbit:'🌀 Orbit', miza:'🌱 Míza', iskra:'⚡ Iskra', ferum:'🛡️ Ferum' };
    el.innerHTML = Object.entries(PERSONAS).map(([k,v])=>`<button class="chip personaChoice" data-persona="${k}">${v}</button>`).join('');
    el.querySelectorAll('.personaChoice').forEach(b=> b.addEventListener('click', ()=>{ state.persona=b.dataset.persona; save(); }));
  }

  // Workshop (jednoduchý)
  function wsWrite(text,cls='ok',replace=false){ const el=$('#wsLog'); if(replace) el.innerHTML=''; const div=document.createElement('div'); div.className=cls; div.textContent=text; el.appendChild(div); el.scrollTop=el.scrollHeight; }
  function renderWS(){ $('#workshop').classList.add('show'); if(!state.workshop.last){ wsWrite('Tip: Klikni na „Navrhnout patch“.', 'warn', true); } }
  function proposePatch(){
    const p = { kind:'enable_shop_button', payload:{enable:true}, log:['Plánovač: Hráč chce obchod.','Kodér: Povoleno tlačítko.','Recenzent: UI only.'] };
    state.workshop.last=p; state.workshop.queue.push(p);
    wsWrite(`🔎 Návrh patchu: ${p.kind}\n• `+p.log.join('\n• '),'ok');
  }
  function applyLastPatch(){
    const p=state.workshop.last; if(!p){ wsWrite('Žádný patch k aplikaci.','warn'); return; }
    if(p.kind==='enable_shop_button'){ const btn=$('#shopBtn'); if(btn){ btn.disabled=false; btn.title=''; btn.onclick=()=>alert('🛍️ Obchod bude ve v0.4: tuning hlasu, +1 energy cap, kosmetika mapy.'); } wsWrite('✅ Obchod povolen (placeholder).','ok'); state.workshop.history.push(p); state.workshop.last=null; save(); }
  }
  function undoPatch(){ wsWrite('↩️ Vráceno (reload UI).','warn'); save(); location.reload(); }

  // Init
  if(!('speechSynthesis' in window)) $('#voiceToggle').style.display='none';
  if(!(window.SpeechRecognition||window.webkitSpeechRecognition)) $('#micToggle').style.display='none';
  updateStats(); renderLog(); draw();
  const _aiRespond=aiRespond; aiRespond=function(){ _aiRespond(); };

  // Helpers
  function renderLog(){ const el=$('#log'); el.innerHTML=state.log.slice(0,12).map(e=>`<div class="log-item">${new Date(e.t).toLocaleTimeString()} — ${e.text.replace(/</g,'&lt;')}</div>`).join(''); }
  function renderChat(){ const list=state.chat.log.slice(0,50).map(m=>`<div class="msg ${m.who==='ai'?'ai':'me'}"><div class="bubble">${m.text.replace(/</g,'&lt;')}</div></div>`).join(''); $('#chatLog').innerHTML=list; $('#chatLog').scrollTop=$('#chatLog').scrollHeight; }
  </script>
</body>
</html>